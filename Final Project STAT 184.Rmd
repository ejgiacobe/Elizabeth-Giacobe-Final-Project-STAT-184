---
title: "Measles Outbreaks"
author: Elizabeth Giacobe
output: html_notebook
---

## Research Question
- How does the measles virus spread over time, in different areas, and in different conditions such as population, population density, and average commute distance?

## Set Up  
```{r, message= FALSE}
#clean ups
rm(list = ls()) 

#loaded needed packages
library(tidyverse)
library(rvest)
library(party)
library(rpart)
library(rpart.plot)
library(leaflet)
```

## Data Access
I accessed all data that will be used to address the research question. The Measles data was downloaded from the World Health Organization's free database. The other data on the different countries was pulled from various published websites. This section is significant to the project because it is where I will get all of the data. 

### Commute Distance Data
```{r}
page2 <- "https://www.nationmaster.com/country-info/stats/Transport/Commute/Distance"
tableList2 <- page2 %>%
  read_html() %>%
  html_nodes(css = "table") %>%
  html_table(fill = TRUE)

RawTransport <- tableList2[[1]]

head(RawTransport)
```

Note: There are many variables that aren't needed. The distances have units in them and they are character strings. 

### Population Density Data
```{r}
page1 <- "https://www.nationmaster.com/country-info/stats/Geography/Area/Land/Per-capita"
tableList1 <- page1 %>%
  read_html() %>%
  html_nodes(css = "table") %>%
  html_table(fill = TRUE)

RawCountries <- tableList1[[1]]

head(RawCountries)
```

Note: There are variables that aren't needed. The population densities have units and are character strings. 

### Latitude and Longitude Data
```{r}
page3 <- "http://techslides.com/list-of-countries-and-capitals"
tableList3 <- page3 %>%
  read_html() %>%
  html_nodes(css = "table") %>%
  html_table(fill = TRUE)

RawLatLon <- tableList3[[1]]

head(RawLatLon)
```

Note: The first row is the variable names. The latitude and longitude are both character strings. 

### Population Data
```{r}
page4 <- "http://worldpopulationreview.com/countries/"
tableList4 <- page4 %>%
  read_html() %>%
  html_nodes(css = "table") %>%
  html_table(fill = TRUE)

RawPopulations <- tableList4[[1]]

head(RawPopulations)
```

### Measles Data
```{r, message=FALSE}
# getting data
MeaslesOutbreaksRaw <- read_csv("MeaslesOutbreaks.csv")

MeaslesVac1Raw <- read_csv("Measles1Vac.csv")

MeaslesVac2Raw <- read_csv("Measles2Vac.csv")

head(MeaslesOutbreaksRaw)
head(MeaslesVac1Raw)
head(MeaslesVac2Raw)
```
  
Note: There are multiple variables for the same information in the outbreaks data. The variable names are not correct for the vaccinataion data.

```{r}
nrow(MeaslesOutbreaksRaw)
nrow(MeaslesVac1Raw)
nrow(MeaslesVac2Raw)
```
  
Note: The vaccine data doesn't have the same amount of cases so see which countries aren't included in the Vac2 data that are included in the Vac1 data. 

## Data Wrangling
### Cleaning Data
During this section of the project I will clean the data so that it is in a form that I am able to use and combine with other data frames. This is important becacuse the data from off the web comes in multiple forms and they may not all match (which they don't). 

#### Commute Distance Data
```{r}
Transport <-
  RawTransport %>%
  select(COUNTRY, AMOUNT) %>%
  rename(country = COUNTRY, distance = AMOUNT) %>%
  mutate(distance = readr::parse_number(distance))

head(Transport)
```

#### Population Density Data
```{r}
Countries <-
  RawCountries %>%
  select(COUNTRY, AMOUNT) %>%
  rename(country = COUNTRY, pop_dens = AMOUNT) %>%
  mutate(pop_dens = readr::parse_number(pop_dens)) %>%
  filter(!grepl("[(profile)]$", country))

head(Countries)
```

#### Latitude and Longitude Data
```{r}
LatLon <-
  RawLatLon %>%
  rename("country" = "X1", "capital" = "X2", "lat" = "X3", "lon" = "X4") %>%
  select(country, lat, lon) %>%
  mutate(lat = as.numeric(lat)) %>%
  mutate(lon = as.numeric(lon))

LatLon = LatLon[-1, ]

head(LatLon)
```

#### Population Data
```{r}
Populations <-
  RawPopulations %>%
  rename("country" = "X2", "population" = "X3") %>%
  select(country, population) %>%
  mutate(population = readr::parse_number(population))

Populations = Populations[-1, ]

head(Populations)
```

#### Measles Data
##### Outbreaks
```{r}
MeaslesOutbreaks <-
  MeaslesOutbreaksRaw %>%
  rename("year" = "YEAR (DISPLAY)", "region" = "REGION (DISPLAY)", "income_group" = "WORLDBANKINCOMEGROUP (DISPLAY)", "country" = "COUNTRY (DISPLAY)", "outbreaks" = "Display Value") %>%
  select(year, region, country, outbreaks)

head(MeaslesOutbreaks)
```

##### Vaccine 1
```{r}
# makes variable names the contents of the first row
colnames(MeaslesVac1Raw) <- as.character(unlist(MeaslesVac1Raw[1,]))

# takes out first row (repeat of variable names)
MeaslesVac1 = MeaslesVac1Raw[-1, ]

head(MeaslesVac1)
```

```{r}
# used the gather function to make Vac1 narrow
MeaslesVac1Narrow <-
  MeaslesVac1 %>%
  select(Country, `2000`, `2001`, `2002`, `2003`, `2004`, `2005`, `2006`, `2007`, `2008`, `2009`, `2010`, `2011`, `2012`, `2013`, `2014`, `2015`, `2016`, `2017`, `2018`) %>%
  gather(key = "year", value = vac1, `2000`, `2001`, `2002`, `2003`, `2004`, `2005`, `2006`, `2007`, `2008`, `2009`, `2010`, `2011`, `2012`, `2013`, `2014`, `2015`, `2016`, `2017`, `2018`)

head(MeaslesVac1Narrow)
```

Note: Year is a character string not a number

```{r}
MeaslesVac1Narrow <-
  MeaslesVac1Narrow %>%
  mutate(year = as.numeric(year))

head(MeaslesVac1Narrow)
```

##### Vaccine 2
```{r}
# makes variable names the contents of the first row
colnames(MeaslesVac2Raw) <- as.character(unlist(MeaslesVac2Raw[1,]))

# takes out first row (repeat of variable names)
MeaslesVac2 = MeaslesVac2Raw[-1, ]

head(MeaslesVac2)
```

```{r}
# used the gather function to make Vac2 narrow
MeaslesVac2Narrow <-
  MeaslesVac2 %>%
  select(Country, `2000`, `2001`, `2002`, `2003`, `2004`, `2005`, `2006`, `2007`, `2008`, `2009`, `2010`, `2011`, `2012`, `2013`, `2014`, `2015`, `2016`, `2017`, `2018`) %>%
  gather(key = "year", value = vac2, `2000`, `2001`, `2002`, `2003`, `2004`, `2005`, `2006`, `2007`, `2008`, `2009`, `2010`, `2011`, `2012`, `2013`, `2014`, `2015`, `2016`, `2017`, `2018`)

head(MeaslesVac2Narrow)
```

Note: Year is a character string not a number

```{r}
MeaslesVac2Narrow <-
  MeaslesVac2Narrow %>%
  mutate(year = as.numeric(year))

head(MeaslesVac2Narrow)
```

### Summarizing Outbreak Data
I have to summarize the outbreak data so that I am able to join it with the other data frames and start looking for patterns. 

```{r}
MeaslesOutbreaksSum <-
  MeaslesOutbreaks %>%
  group_by(year, country, region) %>%
  summarise(outbreaks = sum(outbreaks)) %>%
  filter(grepl("^20", year)) %>%
  arrange(desc(outbreaks))

head(MeaslesOutbreaksSum)
```

### Joining Data
It is essential to join the data so that we can look at the relationships between variables and address the research question. 

#### Joining Vaccine 1 and Vaccine 2 Data
```{r}
MeaslesVac <-
  left_join(MeaslesVac1Narrow, MeaslesVac2Narrow, by = c("Country", "year")) %>%
  rename("country"= "Country")
  
head(MeaslesVac)
```

#### Joining Vaccine and Oubreaks Data
```{r}
Measles <-
  inner_join(MeaslesOutbreaksSum, MeaslesVac, by = c("country", "year")) %>%
  arrange(desc(outbreaks))

head(Measles)
```

#### Joining Population Density, Commute Distance, and Coordinate Data to Measles Data
```{r}
MeaslesPop <-
  inner_join(Countries, Measles, by = "country", "country")

MeaslesPop <-
  inner_join(MeaslesPop, Populations, by = "country", "country")

MeaslesPopTransport <-
  inner_join(Transport, MeaslesPop, by = "country", "country")

MeaslesFull <-
  inner_join(MeaslesPopTransport, LatLon, by = "country", "country") %>%
  mutate(vac_tot = vac1 + vac2) %>%
  arrange(desc(outbreaks))

head(MeaslesFull)
```

### Summarizing Data
To look for patterns in areas that have the most measles outbreaks I summarised the data to look for the countries with the highest risk of outbreaks and what regions they were in. 

```{r}
HighRisk <-
  Measles %>%
  group_by(country, region) %>%
  summarise(tot_outbreaks = sum(outbreaks), tot_years = n_distinct(year)) %>%
  mutate(avg_outbreaks = tot_outbreaks/tot_years) %>%
  filter(avg_outbreaks > 5000) %>%
  arrange(desc(avg_outbreaks))

HighRisk
```

```{r}
  HighRisk %>%
  group_by(region) %>%
  summarise(prop = (n_distinct(country))/(21)) %>%
  arrange(desc(prop))
```

In this section I fit a linear model to the full data set. I printed the summary to look at the results of the significant factors on measles outbreaks. 

```{r}
mod1 <-
  lm(outbreaks ~ vac1 + vac2 + pop_dens + year + population + distance, data = MeaslesFull)
summary(mod1)
```

Conclusions: 
Overall, the spread of the measles virus was significanly impacted by the year (alpha = 0.01), the first measles vaccine (alpha = 0.05), the population (alpha = 0.001), and average commute distance (0.1). The regions in which the virus spreads the most are the Western Pacific, South-East Asia, Europe, and Africa, which had the highest proportion of total high outbreak countries. 

## Data Visualization
```{r fig.height=7, fig.width=12}
Measles %>%
  mutate(vac_tot = vac1 + vac2) %>%
  ggplot() +
  stat_smooth(aes(x = vac_tot, y = outbreaks)) +
  geom_point(aes(x = vac_tot, y = outbreaks, alpha = 0.3, color = region)) +
  ylim(0, 140000) + 
  facet_wrap(~ region)
```

```{r}
mod1 <- rpart(outbreaks ~ vac1 + vac2 + population + pop_dens + distance + year, data = MeaslesFull)
prp(mod1)
```

Conclusions: How does the measles virus spread over time, in different areas, and in different conditions such as population, population density, and average commute distance?